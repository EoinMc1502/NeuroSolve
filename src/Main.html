<!DOCTYPE html>
<html>
<head>
    <title>Neuro Solve - Predictions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 95%;
            margin: auto;
            overflow: hidden;
        }
        header {
            background: #222;
            color: white;
            padding-top: 30px;
            min-height: 70px;
            border-bottom: white 3px solid;
        }
        header a {
            color: #ffffff;
            text-decoration: none;
            text-transform: uppercase;
            font-size: 16px;
        }
        header ul {
            padding: 0;
            margin: 0;
            list-style: none;
            overflow: hidden;
        }
        header li {
            float: left;
            display: inline;
            padding: 0 20px 0 20px;
        }
        header #branding {
            float: left;
        }
        header #branding h1 {
            margin: 0;
        }
        header nav {
            float: right;
            margin-top: 10px;
        }
        header a:hover {
            color: #ffffff;
            font-weight: bold;
        }
        .button {
            height: 50px;
            background: #555;
            border: 0;
            padding-left: 50px;
            padding-right: 50px;
            color: #ffffff;
        }
        .button:hover {
            background: #777;
            cursor: pointer;
        }
        form {
            margin-top: 20px;
            line-height: 2.5;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #555;
            background: #222;
            color: white;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .message-box {
            position: fixed; /* Or absolute, depending on your needs */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        }
        .message-content {
            background-color: #333; /* Dark background for the message */
            color: #fff; /* Light text color for contrast */
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Soft shadow for depth */
            max-width: 650px; /* Adjust based on your content */
            width: 90%; /* Responsive width */
            max-height: 70%; /* Maximum height before scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
            position: relative; /* Needed for proper positioning of close button */
        }

        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #aaa; /* Light grey color for the close button */
            cursor: pointer;
        }
        .close-btn:hover {
            color: #fff; /* White color on hover for the close button */
        }
        .select-container {
            display: flex;
            justify-content: space-between; /* This spreads the children evenly */
            align-items: flex-start; /* Aligns items at the start of the container */
            margin-bottom: 20px; /* Optional: adds some space below the container */
        }

        .select-wrapper {
            flex: 1; /* Each child will take up equal amount of space */
            margin-right: 10px; /* Optional: adds some space between the select elements */
        }

        .select-wrapper:last-child {
            margin-right: 0; /* Removes margin from the last select element */
        }
        #DuplicateContainerButton {
            height: 40px; /* Slightly smaller height compared to the submit button for differentiation */
            background-color: #444; /* Darker than the main button, but lighter than the background */
            color: #ccc; /* Light grey color for visibility against the dark background */
            font-size: 16px;
            font-weight: bold;
            border: none; /* Removes the default border */
            cursor: pointer; /* Changes cursor to pointer on hover */
            margin-top: 20px; /* Adds space between the selects and the button */
            width: 100%; /* Ensures the button stretches to match the form's width */
            transition: background-color 0.3s, color 0.3s; /* Smooth transition for hover effects */
        }

        #DuplicateContainerButton:hover {
            background-color: #555; /* Lightens the button on hover for feedback */
            color: #fff; /* Makes the text color brighter on hover */
        }
        .symptoms-select {
            height: 250px; /* Adjust the height as needed */
            overflow-y: auto; /* Enables vertical scrolling if there are many options */
        }
        .extra-space {
            height: 30px; /* Adjust the height as needed */
        }
        .email-container {
            margin-top: 20px; /* Adds some space above the email container */
            display: flex;
            align-items: center;
            justify-content: space-between; /* Spreads the input and button */
            background-color: #222; /* Dark background */
            padding: 10px;
            border-radius: 5px; /* Soft rounded corners */
        }

        .email-container input[type="email"] {
            width: 70%;
            background-color: #333;
            border: 2px solid #555;
            padding: 10px 15px;
            color: #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        .email-container input[type="email"]::placeholder {
            color: #888;
        }

        .email-container .send-email-button {
            background-color: #444;
            border: none;
            padding: 10px 20px;
            color: #ddd;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
        }

        .email-container .send-email-button:hover {
            background-color: #666;
            color: #fff;
        }
        .add-symptom-button {
            height: 50px;
            background: #444; /* Slightly darker than the main button for differentiation */
            color: #ccc; /* Light color for visibility */
            font-size: 18px; /* Large font size for emphasis */
            border: none; /* No border for a modern look */
            cursor: pointer; /* Changes the cursor to indicate interactiveness */
            margin-top: 20px; /* Space above the button */
            width: 100%; /* Full width of its container for prominence */
            transition: background-color 0.3s, color 0.3s; /* Smooth transition for hover effects */
        }

        .add-symptom-button:hover {
            background: #555; /* Lightens the button on hover for a feedback effect */
            color: #fff; /* Brightens the text color for better visibility */
        }
        .add-symptom-box {
            display: none; /* Initially hidden */
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #222;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 100; /* Ensure it sits above other content */
            width: 400px; /* Adjust based on your needs */
        }

        .add-symptom-box h2 {
            color: #ccc;
            text-align: center;
        }

        .add-symptom-box input[type="text"] {
            width: calc(100% - 24px); /* Full width minus padding */
            padding: 10px;
            margin-bottom: 20px; /* Space between the input and the button */
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: #ddd;
        }

        .add-symptom-box button {
            display: block; /* Ensure it fills the container width */
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #444;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-symptom-box button:hover {
            background-color: #555;
        }
        .close-symptom-box {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #ccc;
        }

        .close-symptom-box:hover {
            color: #fff;
        }

    </style>
</head>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    function calculateAge(dateOfBirth) {
    const dob = new Date(dateOfBirth);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    return age;
    }



    function fetchUserDetails(callback) {
    $.ajax({
        url: 'https://localhost:3000/user-details', // Adjust URL as needed
        type: 'GET',
        xhrFields: {
            withCredentials: true // Important: this includes cookies in the request
        },
        success: function(response) {
            console.log("User details response:", response);
            // Assuming response contains 'UserID'
            if (response.userID) {
                callback(null, response.userID); // Pass UserID to callback
            } else {
                callback("UserID not found in response", null);
            }
        },
        error: function() {
            console.log("Error fetching user details.");
            callback("Error fetching user details.", null);
        }
    });
    }

    function validateForm() {
    const dateOfBirth = $('#dateOfBirth').val();
    const biologicalSex = $('#biologicalSex').val();
    const symptoms = $('#symptoms').val(); // This gets an array of selected symptoms

    // Validate Date of Birth
    if (!dateOfBirth || new Date(dateOfBirth) > new Date()) {
        alert('Please enter a valid Date of Birth. Dates in the future are not allowed.');
        return false;
    }

    // Validate Biological Sex
    if (!biologicalSex || biologicalSex === "") {
        alert('Please select a biological sex.');
        return false;
    }

    // Validate Symptoms
    if (!symptoms || symptoms.length < 3) {
        alert('Please select at least three symptoms.');
        return false;
    }

    return true; // Validation passed
    }



    function submitForm() {
        
        console.log('Submitting form...');


        fetchUserDetails(function(err, userID) {
        if (err) {
            console.error(err);
            return; // Stop form submission if UserID cannot be retrieved
        }


        const formData = {
            userID: userID,
            patientTitle: $('#patientTitle').val(),
            patientFirstName: $('#patientFirstName').val(),
            patientLastName: $('#patientLastName').val(),
            streetAddress: $('#streetAddress').val(),
            city: $('#city').val(),
            state: $('#state').val(),
            postalCode: $('#postalCode').val(),
            biologicalSex: $('#biologicalSex').val(),
            country: $('#country').val(),
            dateOfBirth: $('#dateOfBirth').val(),
            familyHistory: gatherFamilyHistoryData(),
            doctor: $('#doctor').val(),
            symptoms: $('#symptoms').val()
        };

        console.log("Form Symptoms ..................................:", $('#symptoms').val());
        formData.age = calculateAge(formData.dateOfBirth);

        console.log('Form Data:', formData);

        $.ajax({
            url: 'https://localhost:3000/submit-form',
            method: 'POST',
            contentType: 'application/json',
            xhrFields: {
                withCredentials: true // cookies included
            },
            data: JSON.stringify(formData),
            success: function (response) {
                console.log("AJAX response:", response);
                console.log("Response returned: ", response.patientInsertionResult);
                console.log("Reasoning frontend:  ", response.diagnosticReasoning);
                console.log("open ai frontend:  ", response.openAIResponse)
                showDiagnosisProcess(JSON.stringify(response));
            },
            error: function (error) {
                console.error('Error submitting form:', error);
            }
        });
        return false;
    })};


    function gatherFamilyHistoryData() {
    let familyHistoryData = [];

    // Original container data
    const originalContainer = document.getElementById('FamilyHistoryContainer');
    familyHistoryData.push(getSelectValues(originalContainer));

    // Duplicated containers data
    const duplicatedContainers = document.getElementById('DuplicatedContainerContainer').children;
    for (const container of duplicatedContainers) {
        familyHistoryData.push(getSelectValues(container));
    }

    // Filter out any pairs that contain empty values for familyMember or disorder
    familyHistoryData = familyHistoryData.filter(pair => pair.familyMember && pair.disorder);

    // Format data as 'familyMemberId,disorderId;familyMemberId,disorderId;...'
    const formattedFamilyHistory = familyHistoryData.map(pair => `${pair.familyMember},${pair.disorder}`).join(';');
    console.log(formattedFamilyHistory);
    return formattedFamilyHistory;
}

function getSelectValues(container) {
    const familyMemberSelect = container.querySelector('select[name^="FamilyMembers"]');
    const disorderSelect = container.querySelector('select[name^="Disorders"]');
    const familyMemberValue = familyMemberSelect ? familyMemberSelect.value : '';
    const disorderValue = disorderSelect ? disorderSelect.value : '';
    return { familyMember: familyMemberValue, disorder: disorderValue };
}

function fetchSymptoms() {
        fetch('https://localhost:3000/symptoms')
            .then(response => response.json())
            .then(data => {
                const selectElement = document.getElementById('symptoms');
                // Clear existing options first
                selectElement.innerHTML = '';
                data.forEach(symptom => {
                    const option = document.createElement('option');
                    option.value = symptom.ID; // Assuming each symptom has an 'id'
                    option.textContent = symptom.Name; // Assuming each symptom has a 'name'
                    selectElement.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching symptoms:', error));
    }

    // function showDiagnosisProcess(message) {
    //     alert(message);
    // }

    document.addEventListener('DOMContentLoaded', function () {
        // your existing JavaScript code here
        fetchSymptoms();

        fetch('https://localhost:3000/FamilyMembers')
            .then(response => response.json())
            .then(data => {
                const selectElement = document.getElementById('FamilyMembers');
                data.forEach(FamilyMembers => {
                    const option = document.createElement('option');
                    option.value = FamilyMembers.ID; // Assuming each FamilyMember has an 'id'
                    option.textContent = FamilyMembers.Type; // Assuming each FamilyMember has a 'type'
                    selectElement.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching FamilyMembers:', error)

        ,fetch('https://localhost:3000/Disorders')
            .then(response => response.json())
            .then(data => {
                const selectElement = document.getElementById('Disorders');
                data.forEach(Disorders => {
                    const option = document.createElement('option');
                    option.value = Disorders.ID; // Assuming each symptom has an 'id'
                    option.textContent = Disorders.Name; // Assuming each symptom has a 'type'
                    selectElement.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching Disorders:', error)
        // Attach the submitForm function to the form's onsubmit event
        ,$('#submit-form').submit(function (event) {
            event.preventDefault(); // Prevents default form submission
            if (!validateForm()) {
            return false; // Stop form submission if validation fails
            }
            submitForm();
        })));

        const duplicateButton = document.getElementById('DuplicateContainerButton');
        const duplicatedContainer = document.getElementById('DuplicatedContainerContainer');

        duplicateButton.addEventListener('click', function() {
        // Clone the whole container instead of individual selects
        console.log(document.getElementById('FamilyHistoryContainer'));
        const selectContainer = document.getElementById('FamilyHistoryContainer'); // Adjust if there are multiple, maybe use a more specific selector or id
        const clone = selectContainer.cloneNode(true);

        // Iterate through selects within the cloned container to reset their values and adjust their IDs and names
        const selects = clone.querySelectorAll('select');
        selects.forEach((select, index) => {
            select.selectedIndex = 0; // Reset the selected index

            // Generate a unique suffix for ID and name attributes to avoid duplicates
            const uniqueSuffix = Date.now() + "_" + index;
            select.id += `_${uniqueSuffix}`;
            select.name += `_${uniqueSuffix}`;

            // Adjust labels 'for' attribute to match the new select id
            const label = select.previousElementSibling; // Assuming label is directly before select
            if (label && label.tagName === 'LABEL') {
                label.setAttribute('for', select.id);
            }
        });

        // Append the cloned container to the designated duplicated container
        duplicatedContainer.appendChild(clone);
        duplicatedContainer.appendChild(DuplicateContainerButton);
        });
    });
</script>
<script>
    // Existing functions: submitForm(), showDiagnosisProcess(), etc.

    function closeMessageBox() {
        document.getElementById('messageBox').style.display = 'none';
    }

    function closeMessageBoxForSymptoms() {
        document.getElementById('messageBoxForSymptoms').style.display = 'none';
    }

    function showMessage(title, message) {
        document.getElementById('messageBox').style.display = 'flex'; // Show the message box
        document.querySelector('.message-content h2').textContent = title; // Set the message box title
        // document.querySelector('.message-content p').textContent = message; // Set the message text
        document.querySelector('.message-content p').innerHTML = message.replace(/\n/g, '<br>'); // Set the message text, converting newlines to HTML line breaks
    }

    function showMessageForSymptoms(title, message) {
        document.getElementById('messageBoxForSymptoms').style.display = 'flex'; // Show the message box
        document.querySelector('#messageBoxForSymptoms .message-content h2').textContent = title; // Set the message box title
        // document.querySelector('.message-content p').textContent = message; // Set the message text
        document.querySelector('#messageBoxForSymptoms .message-content p').innerHTML = message.replace(/\n/g, '<br>'); // Set the message text, converting newlines to HTML line breaks
    }

    function showDiagnosisProcess(response) {
    // Remove JSON.parse if response is already an object
    if (typeof response === 'string') {
        response = JSON.parse(response);
    }

    let message = `<strong>Prediction:</strong> ${response.predictionResult}<br><br>`; // Added a line break here
    message += `<strong>Diagnostic Key Symptoms For Diagnosing:</strong> ${response.diagnosticReasoning}<br><br>`; // And here
    if (response.openAIResponse) {
        message += `<strong>Further Insights:</strong> ${response.openAIResponse.replace(/\n/g, '<br>')}`;
    }

    // Ensure the message box is initially hidden and only shown when needed
    document.getElementById('messageBox').style.display = 'flex';
    document.querySelector('#messageBox .message-content p').innerHTML = message; // Ensure this selector matches your HTML structure
    }   


    function sendEmail() {
    const email = document.getElementById('emailInput').value;
    const messageContent = document.querySelector('.message-content p').innerHTML; // Assuming message is in <p>

    if (!email) {
        alert("Please enter an email.");
        return;
    }

    // Prepare data to send to your server
    const data = {
        email: email,
        message: messageContent
    };

    // Send data to your server
    $.ajax({
        url: 'https://localhost:3000/send-email', // Update with your server's endpoint
        method: 'POST',
        contentType: 'application/json',
        xhrFields: {
            withCredentials: true // Important: this includes cookies in the request
        },
        data: JSON.stringify(data),
        success: function(response) {
            alert("Email sent successfully!");
        },
        error: function(error) {
            console.error('Error sending email:', error);
            alert("Failed to send email.");
        }
    });
}
    </script>
</body>


</script>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1>Neuro Solve</h1>
            </div>
            <nav>
                <ul>
                    <li class="current"><a href="Home.html">Home</a></li>
                    <li><a href="UserFeedback.html">Feedback</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <h2></h2>
    </div>

    <div class="container">
        <form id="submit-form">
            <label for="patientTitle">Title:</label>
            <select id="patientTitle" name="patientTitle">
                <option value="Mr">Mr</option>
                <option value="Mrs">Mrs</option>
                <option value="Miss">Miss</option>
                <option value="Ms">Ms</option>
                <option value="Dr">Dr</option>
            </select>

            <label for="patientFirstName">First Name: (Optional)</label>
            <input type="text" id="patientFirstName" name="patientFirstName">

            <label for="patientLastName">Last Name: (Optional)</label>
            <input type="text" id="patientLastName" name="patientLastName">

            <label for="doctor">Doctor: (Optional)</label>
            <select name="doctor" id="doctor">
                <option value="">Select Doctor</option>
            </select>

            <label for="streetAddress">Street Address: (Optional)</label>
            <input type="text" id="streetAddress" name="streetAddress">

            <label for="city">City: (Optional)</label>
            <input type="text" id="city" name="city">

            <label for="state">State/Province: (Optional)</label>
            <input type="text" id="state" name="state">

            <label for="postalCode">Postal Code: (Optional)</label>
            <input type="text" id="postalCode" name="postalCode">

            <label for="country">Country: (Optional)</label>
            <input type="text" id="country" name="country">

            <label for="dateOfBirth">Date of Birth: (Required)</label>
            <input type="date" id="dateOfBirth" name="dateOfBirth">

            <label for="biologicalSex">Biological Sex: (Required)</label>
            <select id="biologicalSex" name="biologicalSex">
                <option value="" selected>Please select</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>

            <label>Family History: (Optional)</label>
            <div class="select-container" id="FamilyHistoryContainer">
                <div class="select-wrapper" id="FamilyMembersWrapper">
                    <label for="FamilyMembers">Family Member:</label>
                    <select id="FamilyMembers" name="FamilyMembers">
                        <option value="" selected>Please select</option>
                    </select>
                </div>
                <div class="select-wrapper" id="DisordersWrapper">
                    <label for="Disorders">Disorder:</label>
                    <select id="Disorders" name="Disorders">
                        <option value="" selected>Please select</option>
                    </select>
                </div>
            </div>
            <button type="button" id="DuplicateContainerButton">Add More</button>
            <div id="DuplicatedContainerContainer"></div>

            <label for="symptoms">Symptoms: (At Least 3 Selections Required)</label>
            <select name="symptoms" id="symptoms" multiple class="symptoms-select" multiple></select>
            
            <label for="addNewSymptom"> This Button is for the purpose of adding symptoms that aren't listed above. Please check before using this button.</label>
            <button type="button" class="add-symptom-button" id="addNewSymptom">Add New Symptom</button>

            <div class="extra-space"></div>

            <input type="submit" class="add-symptom-button" value="Submit">
        </form>
    </div>

    <div class="add-symptom-box" id="addSymptomBox">
        <span class="close-symptom-box" id="closeAddSymptomBox">&times;</span>
        <h2>Add New Symptom</h2>
        <input type="text" id="newSymptomName" placeholder="Symptom name">
        <button id="addSymptom">Add</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#addNewSymptom').on('click', function() {
                $('#addSymptomBox').show();
            });

            $('#addSymptom').on('click', function() {
                const newSymptomName = $('#newSymptomName').val();
                if (!newSymptomName) {
                    alert('Please enter a symptom name.');
                    return;
                }

                // Construct the data to send in the POST request
                const data = { newSymptom: newSymptomName };

                // Use jQuery.ajax to send the POST request
                $.ajax({
                    url: 'https://localhost:3000/check-symptom', // Adjust this URL as necessary
                    method: 'POST',
                    contentType: 'application/json',
                    xhrFields: {
                        withCredentials: true // Ensures cookies are included in the request
                    },
                    data: JSON.stringify(data),
                    success: function(response) {
                    console.log('Response:', response);
                    // Update UI based on the response
                    if (response.added) {
                        showMessageForSymptoms('Symptom Added', response.message);
                        fetchSymptoms();
                    } else {
                        showMessageForSymptoms('Symptom Not Added', `${response.message} ${response.similarTo}`);
                    }
                    $('#addSymptomBox').hide();
                    $('#newSymptomName').val(''); // Clear the input field
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    showMessageForSymptoms('Error', 'Failed to check the symptom. ' + error);
                    $('#addSymptomBox').hide();
                }
                });
            });


            $('#closeAddSymptomBox').on('click', function() {
                $('#newSymptomName').val('');
                $('#addSymptomBox').hide(); // Hide the addSymptomBox
            });


            $.ajax({
                url: 'https://localhost:3000/Doctors',
                method: 'GET',
                success: function(response) {
                    const selectElement = document.getElementById('doctor');
                    selectElement.innerHTML = '<option value="">Select Doctor</option>'; // Clear existing options
                    response.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.UserID; 
                        option.textContent = `Dr. ${doctor.FullName}, ${doctor.MedicalFacility}`;
                        selectElement.appendChild(option);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching doctors:', error);
                }
            });
        });
    </script>

    <div class="message-box" id="messageBox" style="display:none;"> <!-- Initially hidden -->
        <div class="message-content">
            <span class="close-btn" onclick="closeMessageBox()">&times;</span>
            <h2>Diagnostic Results</h2>
            <p>This is your message content. You can customize it as needed.</p>

            <!-- Add email input and send button -->
            <div class="email-container">
                <input type="email" id="emailInput" name="userEmail" placeholder="Enter your email to receive a copy" />
                <button type="button" id="sendEmail" class="send-email-button" onclick="sendEmail()">Send</button>
            </div>
        </div>
    </div>

    <div class="message-box" id="messageBoxForSymptoms" style="display:none;"> <!-- Initially hidden -->
        <div class="message-content">
            <span class="close-btn" onclick="closeMessageBoxForSymptoms()">&times;</span>
            <h2>Message Title</h2>
            <p>This is your message content. You can customize it as needed.</p>
        </div>
    </div>
    
    <div class="extra-space"></div>
</body>
</html>
